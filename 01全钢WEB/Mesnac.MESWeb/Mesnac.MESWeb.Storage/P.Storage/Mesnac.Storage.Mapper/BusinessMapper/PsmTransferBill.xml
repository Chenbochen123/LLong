<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="Mesnac.Storage.Mapper.BusinessMapper.PsmTransferBill"
	xmlns="http://ibatis.apache.org/mapping"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <statements>
    <!--查询数据-->
    <sql id="includeSelect">
      <![CDATA[SELECT * FROM PSM_TRANSFER_BILL ]]>
    </sql>
    <!--查询条件-->
    <sql id="includeWhere">
      <dynamic prepend="WHERE">
        <isNotNull property="where.InterfaceUpdateTime" prepend="AND">
          <![CDATA[INTERFACE_UPDATE_TIME = #where.InterfaceUpdateTime#]]>
        </isNotNull>
        <isNotNull property="where.ObjId" prepend="AND">
          <![CDATA[OBJID = #where.ObjId#]]>
        </isNotNull>
        <isNotNull property="where.RecordUserId" prepend="AND">
          <![CDATA[RECORD_USER_ID = #where.RecordUserId#]]>
        </isNotNull>
        <isNotNull property="where.RecordTime" prepend="AND">
          <![CDATA[RECORD_TIME = #where.RecordTime#]]>
        </isNotNull>
        <isNotNull property="where.BackupFlag" prepend="AND">
          <![CDATA[BACKUP_FLAG = #where.BackupFlag#]]>
        </isNotNull>
        <isNotNull property="where.BackupTime" prepend="AND">
          <![CDATA[BACKUP_TIME = #where.BackupTime#]]>
        </isNotNull>
        <isNotNull property="where.DeleteFlag" prepend="AND">
          <![CDATA[DELETE_FLAG = #where.DeleteFlag#]]>
        </isNotNull>
        <isNotNull property="where.FactoryId" prepend="AND">
          <![CDATA[FACTORY_ID = #where.FactoryId#]]>
        </isNotNull>
        <isNotNull property="where.SeqIndex" prepend="AND">
          <![CDATA[SEQ_INDEX = #where.SeqIndex#]]>
        </isNotNull>
        <isNotNull property="where.Remark" prepend="AND">
          <![CDATA[REMARK = #where.Remark#]]>
        </isNotNull>
        <isNotNull property="where.ReserNo" prepend="AND">
          <![CDATA[RESER_NO = #where.ReserNo#]]>
        </isNotNull>
        <isNotNull property="where.ReserItem" prepend="AND">
          <![CDATA[RESER_ITEM = #where.ReserItem#]]>
        </isNotNull>
        <isNotNull property="where.MovType" prepend="AND">
          <![CDATA[MOV_TYPE = #where.MovType#]]>
        </isNotNull>
        <isNotNull property="where.MatCode" prepend="AND">
          <![CDATA[MAT_CODE = #where.MatCode#]]>
        </isNotNull>
        <isNotNull property="where.Unit" prepend="AND">
          <![CDATA[UNIT = #where.Unit#]]>
        </isNotNull>
        <isNotNull property="where.Department" prepend="AND">
          <![CDATA[DEPARTMENT = #where.Department#]]>
        </isNotNull>
        <isNotNull property="where.Qty" prepend="AND">
          <![CDATA[QTY = #where.Qty#]]>
        </isNotNull>
        <isNotNull property="where.PlantFrom" prepend="AND">
          <![CDATA[PLANT_FROM = #where.PlantFrom#]]>
        </isNotNull>
        <isNotNull property="where.StorLocFrom" prepend="AND">
          <![CDATA[STOR_LOC_FROM = #where.StorLocFrom#]]>
        </isNotNull>
        <isNotNull property="where.PlantTo" prepend="AND">
          <![CDATA[PLANT_TO = #where.PlantTo#]]>
        </isNotNull>
        <isNotNull property="where.StorLocTo" prepend="AND">
          <![CDATA[STOR_LOC_TO = #where.StorLocTo#]]>
        </isNotNull>
        <isNotNull property="where.CostCenter" prepend="AND">
          <![CDATA[COST_CENTER = #where.CostCenter#]]>
        </isNotNull>
        <isNotNull property="where.Order1" prepend="AND">
          <![CDATA[ORDER_1 = #where.Order1#]]>
        </isNotNull>
        <isNotNull property="where.DemondsDate" prepend="AND">
          <![CDATA[DEMONDS_DATE = #where.DemondsDate#]]>
        </isNotNull>
        <isNotNull property="where.Batch" prepend="AND">
          <![CDATA[BATCH = #where.Batch#]]>
        </isNotNull>
        <isNotNull property="where.Dummy1" prepend="AND">
          <![CDATA[DUMMY_1 = #where.Dummy1#]]>
        </isNotNull>
        <isNotNull property="where.Dummy2" prepend="AND">
          <![CDATA[DUMMY_2 = #where.Dummy2#]]>
        </isNotNull>
        <isNotNull property="where.Dummy3" prepend="AND">
          <![CDATA[DUMMY_3 = #where.Dummy3#]]>
        </isNotNull>
        <isNotNull property="where.Dummy4" prepend="AND">
          <![CDATA[DUMMY_4 = #where.Dummy4#]]>
        </isNotNull>
        <isNotNull property="where.BillCode" prepend="AND">
          <![CDATA[BILL_CODE = #where.BillCode#]]>
        </isNotNull>
        <isNotNull property="where.TransferDate" prepend="AND">
          <![CDATA[TRANSFER_DATE = #where.TransferDate#]]>
        </isNotNull>
        <isNotNull property="where.UpdateTime" prepend="AND">
          <![CDATA[UPDATE_TIME = #where.UpdateTime#]]>
        </isNotNull>
        <isNotNull property="where.UpdateUserId" prepend="AND">
          <![CDATA[UPDATE_USER_ID = #where.UpdateUserId#]]>
        </isNotNull>
        <isNotNull property="where.AffirmTime" prepend="AND">
          <![CDATA[AFFIRM_TIME = #where.AffirmTime#]]>
        </isNotNull>
        <isNotNull property="where.AffirmUserId" prepend="AND">
          <![CDATA[AFFIRM_USER_ID = #where.AffirmUserId#]]>
        </isNotNull>
        <isNotNull property="where.BillState" prepend="AND">
          <![CDATA[BILL_STATE = #where.BillState#]]>
        </isNotNull>
      </dynamic>
    </sql>
    <!--排序条件-->
    <sql id="includeOrderString">
      <isNotNull property="OrderString" prepend="">
        ORDER BY $OrderString$
      </isNotNull>
    </sql>

    <!--查询实例说明-->
    <select id="GetPageDataByReader" parameterClass="map" resultClass="Row">
      <include refid="includeSelect"/>
      <include refid="includeWhere"/>
      <include refid="includeOrderString"/>
    </select>

    <!--查询调拨单(打印)-->
    <select id="Select@TransferBillPrint" parameterClass="map" resultClass="Row">
      <![CDATA[
      SELECT B.*
      , CASE B.BILL_STATE WHEN 0 THEN '未确认' WHEN 1 THEN '已确认' ELSE '' END BILL_STATE_CAPTION
      , C.CUSTOME_NAME CUSTOMER_NAME
      , UA.USER_NAME AFFIRM_USER_NAME
      , (SELECT SUM(PLAN_AMOUNT) FROM PSM_TRANSFER_MAIN M WHERE B.OBJID = M.BILL_ID AND M.DELETE_FLAG = 0) PLAN_AMOUNT
      , (SELECT SUM(TRANSFER_AMOUNT) FROM PSM_TRANSFER_MAIN M WHERE B.OBJID = M.BILL_ID AND M.DELETE_FLAG = 0) TRANSFER_AMOUNT
      FROM PSM_TRANSFER_BILL B
      LEFT JOIN PSB_CUSTOMER C ON B.DEPARTMENT = C.CUSTOMER_ID AND C.DELETE_FLAG = 0 AND B.MOV_TYPE = 'Z07'
      LEFT JOIN SSB_USER UA ON B.AFFIRM_USER_ID = UA.OBJID
      ]]>
      <dynamic prepend="WHERE">
        <isNotNull property="where.DeleteFlag" prepend="AND">
          <![CDATA[B.DELETE_FLAG = #where.DeleteFlag#]]>
        </isNotNull>
        <isNotNull property="where.ReserNo" prepend="AND">
          <![CDATA[B.RESER_NO = #where.ReserNo#]]>
        </isNotNull>
        <isNull property="where.ReserNo">
          <isNotNull property="where.TyreNo" prepend="AND">
            <![CDATA[
            EXISTS (
              SELECT * 
              FROM PSM_TRANSFER_DETAIL D 
              WHERE B.OBJID = D.BILL_ID
              AND D.DELETE_FLAG = 0 
              AND D.TYRE_NO = #where.TyreNo#
            )
            ]]>
          </isNotNull>
          <isNull property="where.TyreNo">
            <isNotNull property="where.GreenTyreNo" prepend="AND">
              <![CDATA[
              EXISTS (
                SELECT * 
                FROM PSM_TRANSFER_DETAIL D 
                WHERE B.OBJID = D.BILL_ID
                AND D.DELETE_FLAG = 0 
                AND D.GREEN_TYRE_NO = #where.GreenTyreNo#
              )
              ]]>
            </isNotNull>
            <isNull property="where.GreenTyreNo">
              <isNotNull property="where.DemondsDate" prepend="AND">
                <![CDATA[B.DEMONDS_DATE = #where.DemondsDate#]]>
              </isNotNull>
              <isNotNull property="where.CustomerName" prepend="AND">
                <![CDATA[C.CUSTOMER_NAME LIKE '%' || #where.CustomerName# || '%']]>
              </isNotNull>
            </isNull>
          </isNull>
        </isNull>
      </dynamic>
      <isNotNull property="OrderString" prepend="">
        ORDER BY $OrderString$
      </isNotNull>
    </select>

    <!--查看调拨单(打印)-->
    <select id="View@TransferBillPrint" parameterClass="map" resultClass="Row">
      <![CDATA[
      SELECT B.RESER_NO, B.DUMMY_2, B.DUMMY_1, B.TRANSFER_DATE
      , C.CUSTOME_NAME CUSTOMER_NAME
      FROM PSM_TRANSFER_BILL B
      LEFT JOIN PSB_CUSTOMER C ON B.DEPARTMENT = C.CUSTOMER_ID AND C.DELETE_FLAG = 0 AND B.MOV_TYPE = 'Z07'
      ]]>
      <![CDATA[
      WHERE B.OBJID = #ObjId#
      ]]>
    </select>

    <!--查找调拨汇总-->
    <select id="Select@TransferMainPrint" parameterClass="map" resultClass="Row">
      <![CDATA[
      SELECT MM.MATERIAL_CODE, M.TRANSFER_AMOUNT MAIN_AMOUNT
      FROM PSM_TRANSFER_MAIN M
      LEFT JOIN SBM_MATERIAL MM ON M.MATERIAL_ID = MM.OBJID AND M.DELETE_FLAG = 0
      ]]>
      <![CDATA[
      WHERE M.BILL_ID = #BillId#
      AND M.DELETE_FLAG = 0
      ]]>
    </select>

    <!--查找调拨明细-->
    <select id="Select@TransferDetailPrint" parameterClass="map" resultClass="Row">
      <![CDATA[
      SELECT D.TYRE_NO, MM.MATERIAL_CODE, M.TRANSFER_AMOUNT MAIN_AMOUNT
      FROM PSM_TRANSFER_DETAIL D
      JOIN PSM_TRANSFER_MAIN M ON D.MAIN_ID = M.OBJID
      LEFT JOIN SBM_MATERIAL MM ON M.MATERIAL_ID = MM.OBJID AND M.DELETE_FLAG = 0
      ]]>
      <![CDATA[
      WHERE M.BILL_ID = #BillId#
      AND M.DELETE_FLAG = 0
      AND D.DELETE_FLAG = 0
      ]]>
    </select>
    <select id="GetMaterialName" parameterClass="map" resultClass="Row">
      <![CDATA[
      select t.* from sbm_material t 
      ]]>
      <dynamic prepend="WHERE">
        <isNotNull property="deleteFlag" prepend="AND">
        <![CDATA[t.delete_flag=#deleteFlag#]]>  
        </isNotNull>
        <isNotNull property="sapCode" prepend="AND">
          <![CDATA[t.sap_code=#sapCode#]]>
        </isNotNull>
      </dynamic>
    </select>
  </statements>
</sqlMap>
